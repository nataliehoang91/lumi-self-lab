generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////////////
// USER ACCOUNT (linked to Clerk)
////////////////////////////////////////////////////////////

model User {
  id              String   @id @default(cuid())
  clerkUserId     String   @unique // from Clerk: auth().userId
  email           String?  // User email (synced from Clerk)
  accountType     String   @default("individual") // individual | organisation
  role            String   @default("user") // user | super_admin (global admin for whole app; distinct from org_admin)
  upgradedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  experiments     Experiment[]
  organisationMemberships OrganisationMember[] @relation("OrganisationMemberships")
  createdOrganisations Organisation[] @relation("CreatedOrganisations") // Organisations this user created (if org account)

  @@index([clerkUserId])
  @@index([accountType])
  @@index([email])
  @@index([role])
}

////////////////////////////////////////////////////////////
// ORGANISATION
////////////////////////////////////////////////////////////

model Organisation {
  id              String   @id @default(cuid())
  name            String
  description     String?
  createdBy       String   // clerkUserId of creator
  creator         User?    @relation("CreatedOrganisations", fields: [createdBy], references: [clerkUserId], onDelete: SetNull)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  members         OrganisationMember[]
  invites        OrganisationInvite[]
  templates      OrganisationTemplate[]
  experiments    Experiment[] // experiments linked to this org

  @@index([createdBy])
}

////////////////////////////////////////////////////////////
// ORGANISATION MEMBERSHIP
////////////////////////////////////////////////////////////

model OrganisationMember {
  id              String   @id @default(cuid())
  organisationId  String
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  clerkUserId     String
  user            User     @relation("OrganisationMemberships", fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)
  role            String   @default("member") // member | team_manager | org_admin
  teamId          String?  // Optional: for team_manager, specifies which team they manage
  teamName        String?  // Optional: denormalized team name for easier queries
  joinedAt        DateTime @default(now())

  @@unique([organisationId, clerkUserId])
  @@index([clerkUserId])
  @@index([organisationId])
  @@index([role])
}

////////////////////////////////////////////////////////////
// ORGANISATION INVITE (Phase 5: token-based, one-time)
////////////////////////////////////////////////////////////

model OrganisationInvite {
  id              String    @id @default(cuid())
  organisationId  String
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  email           String    // normalised lowercase
  role            String    @default("member") // member | team_manager | org_admin
  token           String    @unique
  invitedBy       String    // clerkUserId
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime  @default(now())

  @@index([organisationId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

////////////////////////////////////////////////////////////
// SYSTEM EXPERIMENT TEMPLATES (Phase T.1 — seeded, read-only)
////////////////////////////////////////////////////////////

model ExperimentTemplate {
  id            String   @id @default(cuid())
  key           String   @unique
  title         String
  description   String?
  durationDays  Int?
  frequency     String?

  // T.2 — metadata for UI (display-only, system-owned)
  categories    String[]  @default([]) // e.g. ["Wellness & Health"]
  tags          String[]  @default([]) // e.g. ["Energy", "Morning Routine"]
  featured      Boolean   @default(false)
  difficulty    String?   // "Easy" | "Medium" | "Hard"
  rating        Float?    // static for now
  usageCount    Int?      // static for now

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  fields        ExperimentTemplateField[]

  @@index([key])
}

model ExperimentTemplateField {
  id             String   @id @default(cuid())
  templateId     String
  template       ExperimentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  label          String
  type           String   // text | number | select | emoji | yesno
  required       Boolean  @default(false)
  order          Int

  textType       String?  // short | long
  minValue       Int?
  maxValue       Int?
  emojiCount     Int?     // 3 | 5 | 7
  selectOptions  String[] // empty array if not select

  @@index([templateId])
}

////////////////////////////////////////////////////////////
// ORGANISATION TEMPLATE
////////////////////////////////////////////////////////////

model OrganisationTemplate {
  id              String   @id @default(cuid())
  organisationId  String
  organisation    Organisation @relation(fields: [organisationId], references: [id], onDelete: Cascade)
  
  title           String
  description     String?
  category        String?
  durationDays    Int
  frequency       String   // daily | every-2-days | weekly
  
  // Template fields (similar to ExperimentField)
  fields          OrganisationTemplateField[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organisationId])
}

model OrganisationTemplateField {
  id              String   @id @default(cuid())
  templateId      String
  template        OrganisationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  label           String
  type            String   // text | number | select | emoji | yesno
  required        Boolean  @default(false)
  order           Int
  
  // Field-specific config
  textType        String?  // short | long
  minValue        Int?
  maxValue        Int?
  emojiCount      Int?     // 3 | 5 | 7
  selectOptions   String[] // empty array if not select

  @@index([templateId])
}

////////////////////////////////////////////////////////////
// EXPERIMENT (top-level object)
////////////////////////////////////////////////////////////

model Experiment {
  id              String   @id @default(cuid())
  clerkUserId     String   // from Clerk: auth().userId
  user            User?    @relation(fields: [clerkUserId], references: [clerkUserId], onDelete: Cascade)

  title           String
  whyMatters      String?
  hypothesis      String?

  durationDays    Int
  frequency       String   // daily | every-2-days | weekly

  faithEnabled    Boolean  @default(false)
  scriptureNotes  String?

  status          String   @default("draft") // draft | active | completed

  // Organisation linking (optional)
  organisationId  String?
  organisation    Organisation? @relation(fields: [organisationId], references: [id], onDelete: SetNull)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  startedAt       DateTime?
  completedAt     DateTime?

  fields          ExperimentField[]
  checkIns        ExperimentCheckIn[]
  reminder        ExperimentReminder?

  @@index([clerkUserId])
  @@index([organisationId])
}

////////////////////////////////////////////////////////////
// FIELD DEFINITIONS (WHAT USER DESIGNS IN UI)
////////////////////////////////////////////////////////////

model ExperimentField {
  id            String   @id @default(cuid())
  experimentId  String
  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  label         String
  type          String   // text | number | select | emoji | yesno
  required      Boolean  @default(false)
  order         Int

  // ---- text ----
  textType      String?  // short | long

  // ---- number ----
  minValue      Int?
  maxValue      Int?

  // ---- emoji ----
  emojiCount    Int?     // 3 | 5 | 7

  // ---- select ----
  selectOptions String[] // empty array if not select

  responses     ExperimentFieldResponse[]

  @@index([experimentId])
}

////////////////////////////////////////////////////////////
// DAILY CHECK-IN (ONE PER DAY PER EXPERIMENT)
////////////////////////////////////////////////////////////

model ExperimentCheckIn {
  id            String   @id @default(cuid())
  experimentId  String
  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  clerkUserId   String
  checkInDate   DateTime

  notes         String?
  aiSummary     String?

  createdAt     DateTime @default(now())

  responses     ExperimentFieldResponse[]

  @@index([experimentId])
  @@index([clerkUserId])
}

////////////////////////////////////////////////////////////
// REMINDER PAUSE + SNOOZE (Phase R.3 / R.4 — per-experiment, notification only)
////////////////////////////////////////////////////////////

model ExperimentReminder {
  experimentId   String     @id
  experiment     Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  pausedAt       DateTime?
  snoozedUntil   DateTime?  // R.4: temporary snooze; auto-resumes after this time
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

////////////////////////////////////////////////////////////
// FIELD RESPONSES (ONE PER FIELD PER CHECK-IN)
////////////////////////////////////////////////////////////

model ExperimentFieldResponse {
  id            String   @id @default(cuid())

  checkInId     String
  checkIn       ExperimentCheckIn @relation(fields: [checkInId], references: [id], onDelete: Cascade)

  fieldId       String
  field         ExperimentField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // ---- response values (only one used depending on field.type)
  // text: uses responseText
  // number: uses responseNumber (minValue to maxValue)
  // emoji: uses responseNumber (1 to emojiCount, where 1=lowest, emojiCount=highest)
  // yesno: uses responseBool
  // select: uses selectedOption
  responseText    String?
  responseNumber  Int?      // For number scale OR emoji ranking (1-based)
  responseBool    Boolean?  // For yes/no
  selectedOption  String?   // For select dropdown

  // ---- future AI
  aiFeedback      String?

  @@index([checkInId])
  @@index([fieldId])
}
