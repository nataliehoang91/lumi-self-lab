generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////////////////////////
// EXPERIMENT (top-level object)
////////////////////////////////////////////////////////////

model Experiment {
  id              String   @id @default(cuid())
  clerkUserId     String   // from Clerk: auth().userId

  title           String
  whyMatters      String?
  hypothesis      String?

  durationDays    Int
  frequency       String   // daily | every-2-days | weekly

  faithEnabled    Boolean  @default(false)
  scriptureNotes  String?

  status          String   @default("draft") // draft | active | completed

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  startedAt       DateTime?
  completedAt     DateTime?

  fields          ExperimentField[]
  checkIns        ExperimentCheckIn[]

  @@index([clerkUserId])
}

////////////////////////////////////////////////////////////
// FIELD DEFINITIONS (WHAT USER DESIGNS IN UI)
////////////////////////////////////////////////////////////

model ExperimentField {
  id            String   @id @default(cuid())
  experimentId  String
  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  label         String
  type          String   // text | number | select | emoji | yesno
  required      Boolean  @default(false)
  order         Int

  // ---- text ----
  textType      String?  // short | long

  // ---- number ----
  minValue      Int?
  maxValue      Int?

  // ---- emoji ----
  emojiCount    Int?     // 3 | 5 | 7

  // ---- select ----
  selectOptions String[] // empty array if not select

  responses     ExperimentFieldResponse[]

  @@index([experimentId])
}

////////////////////////////////////////////////////////////
// DAILY CHECK-IN (ONE PER DAY PER EXPERIMENT)
////////////////////////////////////////////////////////////

model ExperimentCheckIn {
  id            String   @id @default(cuid())
  experimentId  String
  experiment    Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  clerkUserId   String
  checkInDate   DateTime

  notes         String?
  aiSummary     String?

  createdAt     DateTime @default(now())

  responses     ExperimentFieldResponse[]

  @@index([experimentId])
  @@index([clerkUserId])
}

////////////////////////////////////////////////////////////
// FIELD RESPONSES (ONE PER FIELD PER CHECK-IN)
////////////////////////////////////////////////////////////

model ExperimentFieldResponse {
  id            String   @id @default(cuid())

  checkInId     String
  checkIn       ExperimentCheckIn @relation(fields: [checkInId], references: [id], onDelete: Cascade)

  fieldId       String
  field         ExperimentField @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  // ---- response values (only one used depending on field.type)
  // text: uses responseText
  // number: uses responseNumber (minValue to maxValue)
  // emoji: uses responseNumber (1 to emojiCount, where 1=lowest, emojiCount=highest)
  // yesno: uses responseBool
  // select: uses selectedOption
  responseText    String?
  responseNumber  Int?      // For number scale OR emoji ranking (1-based)
  responseBool    Boolean?  // For yes/no
  selectedOption  String?   // For select dropdown

  // ---- future AI
  aiFeedback      String?

  @@index([checkInId])
  @@index([fieldId])
}
